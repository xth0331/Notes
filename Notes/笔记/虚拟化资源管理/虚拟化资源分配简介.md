#　虚拟化资源分配（vsphere）

当可用资源无法满足资源用户的需求时，需要对分配给虚拟机的资源量进行自定义。

资源分配设置用于确定虚拟机提供的CPU、内存和存储资源。

- 预留主机或集群的物理资源。
- 为可以分配给虚拟机的资源量设置上限。
- 保证为特定虚拟机跟配的物理资源始终高于其他虚拟机。

## 资源分配份额

如果某个虚拟机的资源份额是另一个虚拟机的两倍，则在这两个虚拟机争用资源时，第一个虚拟机有权消耗两倍于第二个虚拟机的资源。

份额通常指定为**高**、**正常**或**低**，这些值分别按4:2:1 的比例指定份额。还可以选择自定义(权重)。

指定份额仅对同级虚拟机或资源池（资源池层级结构中具有相同父级的虚拟机或资源池）有意义。同级将根据其相对份额值共享资源，该份额值受预留和限制的约束。为虚拟机分配份额时，始终会将相对于其他已打开电源的虚拟机来为虚拟机指定优先级。

下表显示了虚拟机的默认CPU和内存份额值。对于资源池，默认的CPU份额和内存份额都相同，但是必须将二者相乘，就好像资源池是具有四个虚拟cpu和16GB内存的虚拟机一样。

**份额值**

| 设置 | CPU份额值               | 内存份额值                         |
| ---- | ----------------------- | ---------------------------------- |
| 高   | 每个虚拟CPU具有2000份额 | 所配置的虚拟机内存每兆字节具有20个 |
| 正常 | 每个虚拟CPU具有1000份额 | 所配置的虚拟机内存每兆字节具有10个 |
| 低   | 每个虚拟CPU具有500份额  | 所配置的虚拟机内存每兆字节具有5个  |

例如，一台具有两个虚拟CPU和1GB内存且CPU和内存份额设置为正常，虚拟机具有2×1000个cpu份额和10*1024个内存份额。

##　资源分配预留

预留是vaozheng为虚拟机分配的最少资源量。

仅在有足够的资源满足虚拟机预留时，才允许开机，即使物理机负载较重，服务器也会确保该资源量。

例如，假定有2GHz可用，并且为VM1和VM2各指定了1GHz的预留量，现在每个虚拟机都能保证在需要时获得1GHz，但是如果VM1只用了500MHz，则VM2可以使用1.5GHz。

预留默认为0，可以指定预留保证迅疾始终可以使用最少的必要CPU或内存。

## 资源分配限制

限制功能为可以分配到虚拟机的CPU、内存或存储I/O资源指定上限。

服务器分配给虚拟机的资源可大于预留，但不可大于限制，即使系统上有未使用的资源也是如此。

CPU、内存和存储I/O资源限制默认为无限制。如果内存无限制，则在创建虚拟机时为该虚拟机配置内存量成为其有效限制。

多数情况下，无需指定限制。

## 资源分配设置建议

遵循一下准则：

- 使用**预留**来指定可接受的最低CPU量，而不是想要的量，预留标识的具体资源不会随环境变化而变。主机可以根据虚拟机的限制、份额的数量和估计需求将额外的资源指定为可用资源。
- 请不要将所有资源全部指定为虚拟机预留（请计划经至少10%的资源保留为未预留）。系统容量越接近于被全部预留，想要在不违反接入控制的情况下更改预留和资源池层级结构越困难。在支持DRS的集群内，如果预留完全占用集群或集群内各台主机的容量，则会组织DRS在主机之间迁移。
- 如需频繁更改总可用资源，可使用**份额**在虚拟机之间合理分配资源。例如，如果使用**份额**，并且升级主机，那么即使每个份额代表较大的内存量、CPU量或存储I/O资源量，每个虚拟机也保持相同的优先级（保持相同数量的份额）。

