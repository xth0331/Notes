
# 直接使用路由的负载均衡

直接路由允许真实的服务器直接处理和路由数据包到请求用户，而不是通过LVS路由器传递传出数据包。直接路由器要求真实服务器通过LVS路由器物理连接到网段，并且能够处理和定向传输数据包。



**网络布局**

​	在直接路由器负载均衡配置中，LVS路由器需要接收传入请求并将它们路由到适当的真实服务器以进行处理。然后真正的服务器需要直接将相应路由到客户端。因此，例如，如果客户端在Internet上，并通过LVS路由将数据包发送到真实服务器，则真实服务器必须能够通过Internet直接连接到客户端。这可以通过为真实服务器配置网关以将数据包传递到Internet来完成。服务器池中的每个真实服务器都可以拥有自己独立的网关（并且每个网关都是有自己的Internet），对与典型的LoadBalancer设置，真实服务器可以通过一个网关进行通信。





## 使用arptables进行直接路由

为了使用`arptables`配置直接路由，每个真实服务器必须配置其虚拟ip地址，以便他们可以直接路由数据包。真实服务器完全忽略对VIP的ARP请求，并且可能以其他方式发送包含VIP的任何ARP数据包破坏以包含真实服务器的IP而不是VIP。

使用`arptables`，应用程序可以绑定到真实服务器正在服务的每个单独的VIP端口。例如`arptables`允许多个HTTP Server实例运行并明确绑定到系统上的不同VIP。

要配置每个真实服务器可以忽略每个虚拟IP地址的ARP请求，执行以下步骤：

1. 为每个真实服务器上的每个虚拟IP地址创建ARP表条目（real_ip是导向器用来与真实服务器通信的IP；通常这是绑定到`eth0`的IP）：

   ```bash
   arptables -A IN -d <virtual_ip> -j DROP
   arptables -A OUT -s <virtual_ip> -j mangle --mangle-ip -s <real_ip>
   ```

   这将导致真实服务器忽略对虚拟IP地址的所有ARP请求，并更改可能包含虚拟IP的任何传出ARP响应，以便他们包含服务器的真实IP。应响应任何VIP的ARP请求的唯一节点是当前活动的LVS节点。

2. 在每个真实服务器上完成此操作后，通过在每个真实服务器上键入以下命令来保存ARP表条目：

   ```bash
   arptables-save > /etc/sysconfig/arptables
   systemctl enable arptables.service
   ```

3. 使用 `ip addr`创建IP别名在所有真实服务器上配置虚拟IP地址。

   ```bash
   ip addr add 192.168.76.24 dev eth0
   ```

4. 配置Keepalived以进行直接路由。通过配置`keepalived.conf`；来完成。







