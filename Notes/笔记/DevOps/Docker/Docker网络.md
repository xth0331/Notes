# Docker网络

Docker容器和服务如此强大的原因之一是您可以将它们连接在一起，或将它们连接到非Docker工作负载。Docker容器和服务甚至不需要知道它们已部署在Docker上，也不必知道它们的对等对象是否也是Docker工作负载。无论您的Docker主机运行Linux，Windows还是两者结合，您都可以使用Docker以与平台无关的方式管理它们。

## 网络驱动

Docker的网络子系统可使用驱动程序插入。默认情况下，有几个驱动程序，它们提供核心联网功能：

- `bridge`
- `host`
- `overlay`
- `macvlan`
- `none`
- `network plugins`

### 网络驱动摘要

- 当您需要多个容器在同一Docker主机上进行通信时，最好**使用用户定义的网桥网络**。
- 当网络堆栈不应与Docker主机隔离时，但您希望容器的其他方面隔离，则**主机网络**是最佳选择。
- 当您需要在不同Docker主机上运行的容器进行通信时，或者当多个应用程序使用群服务一起工作时，**覆盖网络**是最好的。
- 从VM设置迁移或需要容器看起来像网络上的物理主机（每个都有唯一的MAC地址）时，**Macvlan网络**是最好的。
- **第三方网络插件**使您可以将Docker与专用网络堆栈集成。

## Bridge网络

在网络方面，桥接网络是在网段之间转发流量的链路层设备。桥可以是在主机内核中运行的硬件设备或软件设备。

就Docker而言，网桥网络使用软件网桥，该软件网桥允许连接到同一网桥网络的容器进行通信，同时与未连接到该网桥网络的容器隔离。Docker网桥驱动程序会自动在主机中安装规则，以使不同网桥网络上的容器无法直接相互通信。

桥接网络适用于在**同一** Docker守护程序主机上运行的容器。

启动Docker时，会自动创建一个默认的桥接网络也称为`bridge`，除非另有说明，否则新启动的容器将连接到它。您还可以创建用户定义的自定义网桥网络。**用户定义的网桥网络优于默认`bridge` 网络。**

### 自定义Bridge和默认Bridge的区别

- 用户定义的网桥可在容器化应用程序之间提供更好的隔离和互操作性。
- 用户定义的网桥可在容器之间提供自动DNS解析。
- 可以动态地从用户定义的网络中附加和分离容器。
- 每个用户定义的网络都创建一个可配置的网桥。
- 默认网桥网络上的链接容器共享环境变量。
  - 多个容器可以使用Docker卷挂载包含共享信息的文件或目录。
  - 可以使用docker-compose一起启动多个容器，并且compose文件可以定义共享变量。
  - 您可以使用集群服务而不是独立的容器，并利用共享的秘密和配置。

## Overlay网络

`overlay`网络驱动程序在多个docker守护进程主机之间创建一个分布式网络。该网络位于特定于主机的网络之上，从而在启动加密后允许其连接到容器进行安全通信。Docker透明地处理每个数据包与正确的Docker守护进程主机和正确的目标容器之间路由。

初始化集群或将Docker主机加入到现有集群时，将创建两个新网络：

- 一个叫做`ingress`的`overlay`网络，它处理与与集群服务相关的控制和数据流量。当创建一个集群，不连接到一个用户定义的`overlay`网络，它默认连接到`ingress`网络。
- 一个名为`docker_gwbridge`的桥接网络，将各个Docker守护进程连接到集群中其他守护进程。

## 主机网络

如果容器使用`host`网络模式，则该容器的网络堆栈不会与Docker主机隔离，并且该容器不会分配自己的IP地址。例如，如果运行一个绑定端口80的容器，并且使用`host`网络，则该容器的应用程序壳在主机IP地址：端口上使用。

`host`模式对于优化性能及容器需要大量端口的情况下很有用，因为它不需要网络地址转换，并且不会为每个端口创建`userland-proxy`

## Macvlan

某些应用程序，尤其是旧应用程序或监控网络流量的应用程序，期望直接连接到物理网络。在这种情况下，可以使用`macvlan`驱动为每个容器的虚拟网络接口分配MAC地址，使其看起来像直接连接到物理网络的物理网络接口。这种情况下，需要在Docker主机上指定用于`macvlan`的物理接口，以及`macvlan`的子网和网关。设置可以使用不同的物理网络接口隔离`macvlan`网络。记住以下几点：

- 由于IP地址耗尽或VLAN扩展，很容易无意之中破坏您的网络，在这种情况下，网络中有大量不正确的唯一MAC地址。
- 网络设备需要能够处理混杂模式，一个物理接口分配多MAC地址。
- 如果应用程序可以使用网桥或`overlay`工作，从长远来看，这样这些解决方案更好。





