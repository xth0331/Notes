# 监控和诊断I/O性能问题

## 使用vmstat监控系统性能

`vmstat`报告整个系统中的进程，内存，分页，块I/O，中断和CPU活动。可以帮助确定I/O子系统是否与性能问题有关。

下列是I/O性能相关的信息：

- **si**

  换入硬盘，或者从交换分区读取，以KB为单位。

- **so**

  从硬盘换出，或者从交换分区读取。以KB为单位。

- **bi**

  写入块，或者以KB为单位写入操作。

- **bo**

  读取块，或者以KB为单位读取操作。

- **wa**

  赈灾等待I/O操作完成的队列部分。



当交换分区和数据为与同一设备上时，交换和换区特别有用。并作为内存使用情况的指示器。

此外，`free` ,`buff`和`cache`列可以帮助识别回写频率。缓存值的突然下降和可用值增加表明回写和页面缓存失效已经开始。

如果使用`vmstat`进行分析表明I/O子系统跟性能降低有关。则可以使用`iostat`来确定影响性能的I/O设备。

## 使用iostat监控I/O性能

**iostat的**是由 SYSSTAT软件包提供的。它报告加载在您系统中的I / O设备。如果使用**的vmstat**的分析显示I / O子系统对性能下降负责，您可以使用 **iostat的**来确定负责的I / O设备。

## 使用blktrace进行详细的I/O分析

`blktrace`提供有关如果在I/O子系统中花费时间的详细信息。伴随`blkparse`读取`blktrace`的原始输出，并生成由`blktrace`记录的输入和输出操作的易读摘要。

## 使用btt分析blktrace输出

`btt`分析`blktrace`输出并显示数据在I/O对战的每个区域中花费的时间量，从而更容易发现系统中的瓶颈。

`blktrace`机制跟踪并由btt分析的一些重要事件是：

- 排队I/O事件（Q）
- 将I/O发送到驱动程序事件（D）
- 完成I/O事件（C）

可以通过检查事件组合来包括或排除与I/O性能问题相关的因素。

要检查每个I/O设备的子部分的时序，查看I/O设备捕获的`blktrace`事件的时序。例如，以下命令报告在内核I/O堆栈（Q2C）的较低部分（包括调度器，驱动程序和硬件层）花费的总时间，最为等待事件平均值：

```bash
iostat -x
```

如果设备花费很长的时间来处理请求（D2C），则设备可能过载，或者发送到设备的工作负载可能是次优的。如果块I/O在分配到存储设备（Q2G）之前排队很长时间，则可能表示正在使用的存储无法为I/O负载提供服务。例如，已达到LUN队列满状态，并组织将I/O分派到存储设备。



查看相邻I/O的时序提供了洞察力。可以深度了解某些类型的瓶颈情况。例如，如果btt显示发送到块蹭（Q2Q）的请求之间的时间大于在块层（Q2C）中花费的请求的总时间，这表示I/O请求之间存在空闲时间，I/O子系统可能不会对性能问题有影响。

比较相邻I/O上的Q2C值可以显示存储服务之间的可变性。值可以是：

- 与小范围相当，或
- 在分布范围内变化很大，这表明存在可能的内存设备侧拥塞问题。

## 使用seekwatcher分析blktrace输出



seekwatcher工具可以使用blktrace输出来绘制I/O随时间变化的图形。侧重磁盘I/O的逻辑块地址（LBA），以兆字节/秒为单位的吞吐量，没秒的查找次数以及没秒的I/O操作数。这有助于确定何时达到设备的每秒操作限制。



