# 配置 RSS

RSS（接收端调整），也叫多队列接收，是通过一些基于硬件的接收队列来分配网络接收进程，从而使入站网络流量可以由多个 CPU 进行处理。RSS 可以用来缓解接收中断进程中由于单个 CPU 过载而出现的瓶颈，并减少网络延迟。

要确定您的网络接口卡是否支持 RSS，须查看多个中断请求队列是否在 `/proc/interrupts` 中有相关的接口。例如，如果用户对 `p1p1` 接口有兴趣：

```bash
egrep 'CPU|p1p1' /proc/interrupts
   CPU0    CPU1    CPU2    CPU3    CPU4    CPU5
89:   40187       0       0       0       0       0   IR-PCI-MSI-edge   p1p1-0
90:       0     790       0       0       0       0   IR-PCI-MSI-edge   p1p1-1
91:       0       0     959       0       0       0   IR-PCI-MSI-edge   p1p1-2
92:       0       0       0    3310       0       0   IR-PCI-MSI-edge   p1p1-3
93:       0       0       0       0     622       0   IR-PCI-MSI-edge   p1p1-4
94:       0       0       0       0       0    2475   IR-PCI-MSI-edge   p1p1-5
```

之前的输出显示 NIC 驱动程序为 `p1p1` 接口创建了 6 个接收队列（`p1p1-0` 至 `p1p1-5`）。也显示出每个队列处理的中断数量以及处理中断的 CPU。在这种情况下，由于有 6 个默认队列，这一特殊的 NIC 驱动程序就为每个 CPU 创建一个队列，这个系统一共有 6 个 CPU。这是 NIC 驱动程序中很常见的模式。

或者用户可以在网络驱动程序加载后查看 `ls -1 /sys/devices/*/*/*device_pci_address*/msi_irqs` 的输出。例如，如果用户对 PCI 地址为 `0000:01:00.0` 的设备感兴趣，可以通过以下指令来列出该设备中断请求队列：

``` bash
ls -1 /sys/devices/*/*/0000:01:00.0/msi_irqs
101
102
103
104
105
106
107
108
109
```

RSS 是默认启用的。RSS 的队列数（或是需要运行网络活动的 CPU ）会由适当的网络驱动程序来进行配置。 `bnx2x` 驱动程序是在 *num_queues* 中进行配置。`sfc` 驱动程序是用 *rss_cpus* 参数进行配置。通常，这都是在 `/sys/class/net/*device*/queues/*rx-queue*/` 中进行配置，其中 *device* 是网络设备的名称（比如 `eth1`），*rx-queue* 是适当的接收队列名称。

配置 RSS 时，红帽推荐限制每一个物理 CPU 内核的队列数量。超线程在分析工具中通常代表独立的内核，但是所有内核的配置队列，包括如超线程这样的逻辑内核尚未被证实对网络性能有益。

启用时，基于每个队列的 CPU 进程数量，RSS 在 CPU 间平等地分配网络进程。但是，用户可以使用 `ethtool` *--show-rxfh-indir* 和 *--set-rxfh-indir* 参数来更改网络活动的分配方式，并权衡哪种类型的网络活动更为重要。

`irqbalance` 后台程序可与 RSS 相结合，以减少跨节点内存及高速缓存行反弹的可能性。这降低了处理网络数据包的延迟。

