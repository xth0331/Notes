# 配置 RPS

RPS（接收端包控制）与 RSS类似，用于将数据包指派至特定的 CPU 进行处理。但是，RPS 是在软件级别上执行的，这有助于防止单个网络接口卡的软件队列成为网络流量中的瓶颈。

较之于基于硬件的 RSS ，RPS 有几个优点：

- RPS 可以用于任何网络接口卡。
- 易于添加软件过滤器至 RPS 来处理新的协议。
- RPS 不会增加网络设备的硬件中断率。但是会引起内处理器间的中断。

每个网络设备和接收队列都要配置 RPS，在 `/sys/class/net/*device*/queues/*rx-queue*/rps_cpus` 文件中，*device* 是网络设备的名称（比如 `eth0`），*rx-queue* 是适当的接收队列名称（例如 `rx-0`）。

`rps_cpus` 文件的默认值为 `0`。这会禁用 RPS，以便处理网络中断的 CPU 也能处理数据包。

要启用 RPS，配置适当的 `rps_cpus` 文件以及特定网络设备和接收队列中须处理数据包的 CPU 。

`rps_cpus` 文件使用以逗号隔开的 CPU 位图。因此，要让 CPU 在一个接口为接收队列处理中断，请将它们在位图里的位置值设为 1。例如，用 CPU 0、1、2 和 3 处理中断，将 `rps_cpus` 的值设为 `00001111` （1+2+4+8），或 `f`（十六进制的值为 15）。

对于单一传输队列的网络设备，配置 RPS 以在同一内存区使用 CPU 可获得最佳性能。在非 NUMA 的系统中，这意味着可以使用所有空闲的 CPU。如果网络中断率极高，排除处理网络中断的 CPU 也可以提高性能。

对于多队列的网络设备，配置 RPS 和 RSS 通常都不会有好处，因为 RSS 配置是默认将 CPU 映射至每个接收队列。但是，如果硬件队列比 CPU 少，RPS依然有用，并且配置 RPS 是来在同一内存区使用 CPU。

